<div class="filter-container">
  <div class="info-buttons-container">
    <button mat-fab extended class="info-button">
      STPM<br />
      {{ applicantCounts.STPM }}
    </button>
    <mat-icon class="operator-icon">add</mat-icon>

    <button mat-fab extended class="info-button">
      Matriculation <br />
      {{ applicantCounts.Matriculation }}
    </button>
    <mat-icon class="operator-icon">add</mat-icon>

    <button mat-fab extended class="info-button">
      Foundation <br />
      {{ applicantCounts.Foundation }}
    </button>
    <mat-icon class="operator-icon">add</mat-icon>

    <button mat-fab extended class="info-button">
      Diploma<br />
      {{ applicantCounts.Diploma }}
    </button>
    <mat-icon class="operator-icon">drag_handle</mat-icon>

    <button mat-fab extended class="info-button">
      TOTAL <br />
      {{ totalApplicants }} Applicant(s)
    </button>
  </div>

  <br />
  <div
    style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem"
  >
    <mat-form-field appearance="fill">
      <mat-label>Filter by Pre-U</mat-label>
      <mat-select
        [(value)]="selectedPreUType"
        (selectionChange)="applyFilter()"
      >
        <mat-option value="">All</mat-option>
        <mat-option value="STPM">STPM</mat-option>
        <mat-option value="Matriculation">Matriculation</mat-option>
        <mat-option value="Foundation">Foundation</mat-option>
        <mat-option value="Diploma">Diploma</mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Filter by Faculty</mat-label>
      <mat-select
        [(value)]="selectedFaculty"
        (selectionChange)="onFacultyChange()"
      >
        <mat-option value="">All</mat-option>
        <mat-option *ngFor="let fac of faculties" [value]="fac.facultyCode">
          {{ fac.faculty }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <mat-form-field appearance="fill">
      <mat-label>Filter by Program</mat-label>
      <mat-select
        [(value)]="selectedProgram"
        (selectionChange)="applyFilter()"
        [disabled]="programDropdownDisabled"
      >
        <mat-option value="">All</mat-option>
        <mat-option *ngFor="let name of filteredProgramNames" [value]="name">
          {{ name }}
        </mat-option>
      </mat-select>
    </mat-form-field>

    <button mat-fab extended class="scan-button" (click)="openScanModal()">
      Scan
      <mat-icon>scanner</mat-icon>
    </button>
    <button mat-fab extended class="add-button" (click)="openAddModal()">
      Add
      <mat-icon>add</mat-icon>
    </button>
  </div>
</div>

<table mat-table [dataSource]="dataSource" class="mat-elevation-z8" matSort>
  <ng-container matColumnDef="id">
    <th mat-header-cell *matHeaderCellDef>No.</th>
    <!-- <td mat-cell *matCellDef="let applicant">{{ applicant.id }}</td> -->
    <td mat-cell *matCellDef="let applicant; let i = index">
      {{ i + 1 }}
    </td>
  </ng-container>

  <ng-container matColumnDef="name">
    <th mat-header-cell *matHeaderCellDef mat-sort-header>Name</th>
    <td mat-cell *matCellDef="let applicant">{{ applicant.name }}</td>
  </ng-container>

  <ng-container matColumnDef="pre_u">
    <th mat-header-cell *matHeaderCellDef>Pre-U</th>
    <td mat-cell *matCellDef="let applicant">
      {{ applicant.preUType }}
      <button
        mat-button
        style="color: green"
        (click)="openPreUResultModal(applicant)"
      >
        <mat-icon>search</mat-icon>
      </button>
    </td>
  </ng-container>

  <ng-container matColumnDef="spm_result">
    <th mat-header-cell *matHeaderCellDef>SPM Result</th>
    <td mat-cell *matCellDef="let applicant">
      <!-- {{ applicant.spmResult }} -->
      <button
        mat-button
        style="color: green"
        (click)="openSpmResultModal(applicant)"
      >
        <mat-icon>search</mat-icon>
      </button>
    </td>
  </ng-container>

  <ng-container matColumnDef="applied_program">
    <th mat-header-cell *matHeaderCellDef>Applied Program</th>
    <td mat-cell *matCellDef="let applicant">
      {{ getProgramName(applicant.appliedProgram) }}
    </td>
  </ng-container>

  <ng-container matColumnDef="action">
    <th mat-header-cell *matHeaderCellDef>Action</th>
    <td mat-cell *matCellDef="let applicant; let rowIndex = index">
      <button mat-button (click)="openApplicantDetailModal(applicant)">
        <mat-icon style="color: green">search</mat-icon>
      </button>
      <button
        mat-button
        style="color: red"
        (click)="confirmDelete(applicant.id)"
      >
        <mat-icon>delete</mat-icon>
      </button>
    </td>
  </ng-container>

  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
  <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
</table>

<div
  *ngIf="dataSource?.filteredData?.length === 0"
  style="text-align: center; padding: 1em"
>
  <i>**No applicants found under this category(s)</i>
</div>

<div class="modal-overlay" *ngIf="isModalOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <h2>{{ modalTitle }}</h2>
    <h3>Personal Info</h3>
    <div *ngFor="let app of modalContent.applicants" class="applicant-info">
      <table class="result-table borderless">
        <tbody>
          <tr>
            <td><strong>Name</strong></td>
            <td>: {{ app.name }}</td>
          </tr>
          <tr>
            <td><strong>Pre-U Type</strong></td>
            <td>: {{ modalContent.preUType }}</td>
          </tr>
          <tr>
            <td><strong>Applied Program</strong></td>
            <td>
              : {{ getProgramName(modalContent.appliedProgram) }} ({{
                modalContent.appliedProgram
              }})
            </td>
          </tr>
          <tr>
            <td><strong>IC Number</strong></td>
            <td>: {{ app.icNumber }}</td>
          </tr>
          <tr>
            <td><strong>Email Address</strong></td>
            <td>: {{ app.address }}</td>
          </tr>
          <tr>
            <td><strong>Gender</strong></td>
            <td>: {{ app.gender }}</td>
          </tr>
        </tbody>
      </table>
      <br />
    </div>
    <div *ngIf="modalTitle === 'Applicant Details' && modalContent">
      <h3>Application Info</h3>

      <h5>SPM Result</h5>
      <table class="result-table">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Grade</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of modalContent.spmResultParsed | keyvalue">
            <td>{{ item.key }}</td>
            <td>{{ item.value }}</td>
          </tr>
        </tbody>
      </table>

      <h5>{{ modalContent.preUType }} Result</h5>
      <table class="result-table">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Grade</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of modalContent.preUResultParsed | keyvalue">
            <td>{{ item.key }}</td>
            <td>{{ item.value }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div *ngIf="modalTitle !== 'Applicant Details' && modalContent">
      <table class="result-table">
        <thead>
          <tr>
            <th>Subject</th>
            <th>Grade</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of modalContent | keyvalue">
            <td>{{ item.key }}</td>
            <td>{{ item.value }}</td>
          </tr>
        </tbody>
      </table>
    </div>

    <button
      mat-raised-button
      class="close-button"
      type="button"
      color="primary"
      (click)="closeModal()"
    >
      Cancel
    </button>
  </div>
</div>

<!-- Add Modal -->
<div class="add-modal-overlay" *ngIf="isAddModalOpen" (click)="closeAddModal()">
  <div class="add-modal-content" (click)="$event.stopPropagation()">
    <h2>Add New Applicant</h2>
    <form [formGroup]="addForm" (ngSubmit)="onAddSubmit()">
      <!-- Personal Info -->
      <div class="personal-info">
        <mat-form-field appearance="fill">
          <mat-label>Name:</mat-label>
          <input matInput formControlName="name" placeholder="Enter Name" />
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Pre-U Type</mat-label>
          <mat-select formControlName="preUType">
            <mat-option value="STPM">STPM</mat-option>
            <mat-option value="Matriculation">Matriculation</mat-option>
            <mat-option value="Foundation">Foundation</mat-option>
            <mat-option value="Diploma">Diploma</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Applying for Faculty</mat-label>
          <mat-select formControlName="faculty">
            <mat-option
              *ngFor="let faculty of faculties"
              [value]="faculty.facultyCode"
            >
              {{ faculty.faculty }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Program Selection -->
        <mat-form-field *ngIf="addForm.get('faculty')?.value" appearance="fill">
          <mat-label>Applying for Program</mat-label>
          <mat-select formControlName="program_code">
            <mat-option
              *ngFor="let program of getProgramsForFacultyDropdown()"
              [value]="program.code"
            >
              {{ program.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>IC Number:</mat-label>
          <input
            matInput
            formControlName="icNumber"
            placeholder="Enter IC Number"
          />
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Email Address:</mat-label>
          <input
            matInput
            formControlName="address"
            placeholder="Enter Email Address"
          />
          <mat-error *ngIf="addForm.get('address')?.hasError('required')">
            Email is required
          </mat-error>
          <mat-error
            *ngIf="
              addForm.get('address')?.hasError('email') &&
              !addForm.get('address')?.hasError('required')
            "
          >
            Invalid email format
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Gender:</mat-label>
          <mat-select formControlName="gender">
            <mat-option value="Female">Female</mat-option>
            <mat-option value="Male">Male</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <br />

      <!-- SPM Results Section (Required) -->
      <h3>SPM Results</h3>
      <div formArrayName="spmResults">
        <div
          *ngFor="let spmGroup of spmResults.controls; let i = index"
          [formGroupName]="i"
          class="result-row"
        >
          <mat-form-field appearance="fill" class="result-field">
            <mat-label>Subject</mat-label>
            <mat-select formControlName="subject">
              <mat-option
                *ngFor="let subject of getAvailableSpmSubjects(i)"
                [value]="subject"
              >
                {{ subject }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="fill" class="result-field">
            <mat-label>Grade</mat-label>
            <input matInput formControlName="grade" placeholder="Enter Grade" />
          </mat-form-field>
          <button
            mat-mini-fab
            color="warn"
            style="box-shadow: none"
            type="button"
            (click)="removeSpmResult(i)"
            class="remove-button"
          >
            <mat-icon>remove</mat-icon>
          </button>
        </div>
      </div>
      <div class="add-result-btn-container">
        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="addSpmResult()"
        >
          <mat-icon>add</mat-icon>Add SPM Result
        </button>
      </div>

      <br /><br />

      <!-- Pre-U Results Section (Choose One) -->
      <h3>Pre-U Results</h3>
      <div formArrayName="preUResults">
        <div
          *ngFor="let preUGroup of preUResults.controls; let j = index"
          [formGroupName]="j"
          class="result-row"
        >
          <mat-form-field appearance="fill" class="result-field">
            <mat-label>Subject</mat-label>
            <mat-select formControlName="subject">
              <mat-option *ngIf="!addForm.get('preUType')?.value" disabled>
                Select Pre-U Type first
              </mat-option>
              <mat-option
                *ngFor="let subject of getAvailablePreUSubjects(j)"
                [value]="subject"
              >
                {{ subject }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="fill" class="result-field">
            <mat-label>Grade</mat-label>
            <input matInput formControlName="grade" placeholder="Enter Grade" />
          </mat-form-field>
          <button
            mat-mini-fab
            (click)="removePreUResult(j)"
            class="remove-button"
            color="warn"
            style="box-shadow: none"
          >
            <mat-icon>remove</mat-icon>
          </button>
        </div>
      </div>
      <div class="add-result-btn-container">
        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="addPreUResult()"
        >
          <mat-icon>add</mat-icon>Add
          {{ addForm.get("preUType")?.value || "Pre-U" }} Result
        </button>
      </div>

      <br /><br />
      <!-- Modal Footer -->
      <div class="modal-footer">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          [disabled]="addForm.invalid"
          style="margin-right: 10px"
        >
          Submit
        </button>
        <button
          mat-raised-button
          color="warn"
          type="button"
          (click)="closeAddModal()"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Scan Modal -->
<div
  class="add-modal-overlay"
  *ngIf="isScanModalOpen"
  (click)="closeScanModal()"
>
  <div class="add-modal-content" (click)="$event.stopPropagation()">
    <h2>Scan New Applicant</h2>
    <form [formGroup]="addForm" (ngSubmit)="onAddSubmit()">
      <!-- Personal Info -->
      <div class="personal-info">
        <mat-form-field appearance="fill">
          <mat-label>Name:</mat-label>
          <input matInput formControlName="name" placeholder="Enter Name" />
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Pre-U Type</mat-label>
          <mat-select formControlName="preUType">
            <mat-option value="STPM">STPM</mat-option>
            <mat-option value="Matriculation">Matriculation</mat-option>
            <mat-option value="Foundation">Foundation</mat-option>
            <mat-option value="Diploma">Diploma</mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Applying for Faculty</mat-label>
          <mat-select formControlName="faculty">
            <mat-option
              *ngFor="let faculty of faculties"
              [value]="faculty.facultyCode"
            >
              {{ faculty.faculty }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <!-- Program Selection -->
        <mat-form-field *ngIf="addForm.get('faculty')?.value" appearance="fill">
          <mat-label>Applying for Program</mat-label>
          <mat-select formControlName="program_code">
            <mat-option
              *ngFor="let program of getProgramsForFacultyDropdown()"
              [value]="program.code"
            >
              {{ program.name }}
            </mat-option>
          </mat-select>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>IC Number:</mat-label>
          <input
            matInput
            formControlName="icNumber"
            placeholder="Enter IC Number"
          />
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Email Address:</mat-label>
          <input
            matInput
            formControlName="address"
            placeholder="Enter Email Address"
          />
          <mat-error *ngIf="addForm.get('address')?.hasError('required')">
            Email is required
          </mat-error>
          <mat-error
            *ngIf="
              addForm.get('address')?.hasError('email') &&
              !addForm.get('address')?.hasError('required')
            "
          >
            Invalid email format
          </mat-error>
        </mat-form-field>

        <mat-form-field appearance="fill">
          <mat-label>Gender:</mat-label>
          <mat-select formControlName="gender">
            <mat-option value="Female">Female</mat-option>
            <mat-option value="Male">Male</mat-option>
          </mat-select>
        </mat-form-field>
      </div>
      <br />

      <!-- SPM Results Section (Required) -->
      <h3>
        SPM Results
        <button
          mat-icon-button
          type="button"
          matTooltip="Read extraction guide"
          (click)="onInfoIconClick($event)"
          aria-label="Extraction Info"
        >
          <mat-icon>info</mat-icon>
        </button>
      </h3>

      <!-- Hidden file input -->
      <input
        type="file"
        #spmFileInput
        accept="application/pdf"
        (change)="onSpmFileSelected($event)"
        style="display: none"
      />

      <div class="add-result-btn-container">
        <button
          mat-raised-button
          color="primary"
          type="button"
          (click)="scanSpmResult()"
        >
          <mat-icon>scanner</mat-icon> Scan SPM Result
        </button>
      </div>

      <div formArrayName="spmResults">
        <div
          *ngFor="let spmGroup of spmResults.controls; let i = index"
          [formGroupName]="i"
          class="result-row"
        >
          <mat-form-field appearance="fill" class="result-field">
            <mat-label>Subject</mat-label>
            <mat-select formControlName="subject">
              <mat-option
                *ngFor="let subject of getAvailableSpmSubjects(i)"
                [value]="subject"
              >
                {{ subject }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="fill" class="result-field">
            <mat-label>Grade</mat-label>
            <input matInput formControlName="grade" placeholder="Enter Grade" />
          </mat-form-field>
          <button
            mat-mini-fab
            color="warn"
            type="button"
            (click)="removeSpmResult(i)"
          >
            <mat-icon>remove</mat-icon>
          </button>
        </div>
        <div class="add-result-btn-container" *ngIf="spmResults.length > 0">
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="addSpmResult()"
          >
            <mat-icon>add</mat-icon>Add SPM Result
          </button>
        </div>
      </div>

      <br /><br />

      <!-- Pre-U Results Section (Choose One) -->
      <h3>Pre-U Results <button
          mat-icon-button
          type="button"
          matTooltip="Read extraction guide"
          (click)="onInfoIconClick($event)"
          aria-label="Extraction Info"
        >
          <mat-icon>info</mat-icon>
        </button></h3>

      <input
        type="file"
        #stpmFileInput
        accept="application/pdf"
        (change)="onStpmFileSelected($event)"
        style="display: none"
      />
      <div class="add-result-btn-container">
        <button
          mat-raised-button
          color="primary"
          type="button"
          [disabled]="!addForm.get('preUType')?.value"
          (click)="scanPreUResult()"
        >
          <mat-icon>scanner</mat-icon>
          Scan {{ addForm.get("preUType")?.value || "Pre-U" }} Result
        </button>
        <br />
        <small
          *ngIf="!addForm.get('preUType')?.value"
          style="color: red; font-style: italic"
        >
          Please select a Pre-U Type before scanning results.
        </small>
      </div>
      <div formArrayName="preUResults">
        <div
          *ngFor="let preUGroup of preUResults.controls; let j = index"
          [formGroupName]="j"
          class="result-row"
        >
          <mat-form-field appearance="fill" class="result-field">
            <mat-label>Subject</mat-label>
            <mat-select formControlName="subject">
              <mat-option *ngIf="!addForm.get('preUType')?.value" disabled>
                Select Pre-U Type first
              </mat-option>
              <mat-option
                *ngFor="let subject of getAvailablePreUSubjects(j)"
                [value]="subject"
              >
                {{ subject }}
              </mat-option>
            </mat-select>
          </mat-form-field>
          <mat-form-field appearance="fill" class="result-field">
            <mat-label>Grade</mat-label>
            <input matInput formControlName="grade" placeholder="Enter Grade" />
          </mat-form-field>
          <button
            mat-mini-fab
            (click)="removePreUResult(j)"
            class="remove-button"
            color="warn"
            style="box-shadow: none"
          >
            <mat-icon>remove</mat-icon>
          </button>
        </div>
        <div class="add-result-btn-container" *ngIf="preUResults.length > 0">
          <button
            mat-raised-button
            color="primary"
            type="button"
            (click)="addPreUResult()"
          >
            <mat-icon>add</mat-icon>Add
            {{ addForm.get("preUType")?.value || "Pre-U" }} Result
          </button>
        </div>
      </div>

      <br /><br />
      <!-- Modal Footer -->
      <div class="modal-footer">
        <button
          mat-raised-button
          color="primary"
          type="submit"
          style="margin-right: 10px"
          [disabled]="addForm.invalid"
        >
          Submit
        </button>
        <button
          mat-raised-button
          color="warn"
          type="button"
          (click)="closeScanModal()"
        >
          Cancel
        </button>
      </div>
    </form>
  </div>
</div>

<ng-template #extractionGuide>
  <h2 mat-dialog-title>PDF Scanning Guide</h2>
  <mat-dialog-content>
    <p>
      <strong> <mat-icon style="color: red">warning</mat-icon> Note:</strong>
      The extraction result may not be 100% accurate due to differences in
      document quality and layout. <br />We recommend double-checking the
      extracted results before submission.
    </p>
    <p>Sample document that increases accuracy:</p>
    <img
      src="assets/spm.png"
      alt="Sample SPM PDF"
      style="width: 100%; border: 1px solid #ccc"
    />
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-template>
