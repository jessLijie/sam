<!-- Search Bar -->
<!-- <mat-form-field appearance="fill" class="search-bar">
  <mat-label>Search applicant</mat-label>
  <input matInput [(ngModel)]="searchTerm" placeholder="Name or IC" />
</mat-form-field> -->

<div class="send-email-container">
  <!-- Lecturer Dropdown -->
  <!-- <mat-form-field appearance="fill" class="lecturer-dropdown">
    <mat-label>Select Lecturer to Send Excel Report</mat-label>
    <mat-select [(value)]="selectedLecturer">
      <mat-option *ngFor="let lecturer of lecturers" [value]="lecturer.email">
        {{ lecturer.name }}
      </mat-option>
    </mat-select>
  </mat-form-field> -->
  <mat-form-field appearance="fill" class="lecturer-input">
    <mat-label>Enter Lecturer Email to Send Excel Report</mat-label>
    <input
      matInput
      [(ngModel)]="selectedLecturer"
      (ngModelChange)="validateEmail()"
      placeholder="e.g. user@domain.com"
    />
    <mat-error *ngIf="selectedLecturer && !emailValid"
      >Invalid email format</mat-error
    >
  </mat-form-field>

  <!-- Send Email Button -->
  <button
    mat-fab
    extended
    class="send-button"
    (click)="sendEmail()"
    [disabled]="!selectedLecturer || !emailValid || isSending"
  >
    <span
      [ngStyle]="{
        'font-size': isSending ? '13px' : 'inherit',
        display: 'flex',
        'align-items': 'center'
      }"
    >
      {{ isSending ? "Sending" : "Send" }}
      <mat-icon *ngIf="!isSending" style="margin-left: 8px">mail</mat-icon>
      <mat-progress-spinner
        *ngIf="isSending"
        diameter="16"
        mode="indeterminate"
        color="white"
        style="margin-left: 8px"
        strokeWidth="3"
      ></mat-progress-spinner>
    </span>
  </button>

  <button mat-fab extended class="report-button" (click)="viewSortedReport()">
    View Report
    <mat-icon>insert_drive_file</mat-icon>
  </button>
</div>

<div class="main-container">
  <!-- Sidebar: Faculties and Programs -->
  <div class="sidebar">
    <mat-accordion>
      <mat-expansion-panel *ngFor="let faculty of faculties">
        <mat-expansion-panel-header>
          <mat-panel-title>{{ faculty.name }}</mat-panel-title>
        </mat-expansion-panel-header>

        <mat-nav-list>
          <mat-list-item
            *ngFor="let program of faculty.programs"
            (click)="selectProgram(program.code)"
            [class.selected]="program.code === selectedProgramCode"
          >
            {{ program.name }}
          </mat-list-item>
        </mat-nav-list>
      </mat-expansion-panel>
    </mat-accordion>
  </div>

  <!-- Main Content: Applicant Table -->
  <div class="content">
    <div *ngIf="filteredApplicants.length > 0" class="quota-button">
      <button mat-raised-button color="warn" class="sort-button">
        Quota: {{ getApprovedCount(selectedProgramCode) }}/{{
          getQuota(selectedProgramCode)
        }}
      </button>
    </div>
    <br /><br />
    <table
      mat-table
      [dataSource]="dataSource"
      class="mat-elevation-z8"
      multiTemplateDataRows
      *ngIf="filteredApplicants.length"
      matSort
    >
      <!-- ID -->
      <!-- <ng-container matColumnDef="id">
        <th mat-header-cell *matHeaderCellDef><strong>No.</strong></th>
        <td mat-cell *matCellDef="let app; let i = index">
          {{ i + 1 }}0000000000
        </td>
      </ng-container> -->

      <!-- Name -->
      <ng-container matColumnDef="name">
        <th mat-header-cell *matHeaderCellDef mat-sort-header>
          <strong>Name</strong>
        </th>
        <td mat-cell *matCellDef="let app">{{ app.name }}</td>
      </ng-container>

      <!-- Program -->
      <!-- <ng-container matColumnDef="program">
        <th mat-header-cell *matHeaderCellDef>Applied Program</th>
        <td mat-cell *matCellDef="let app">{{ getProgramName(app.appliedProgram) }} ({{ app.appliedProgram}})</td>
      </ng-container> -->

      <!-- General Requirement -->
      <ng-container matColumnDef="general">
        <th mat-header-cell *matHeaderCellDef>
          <strong>General Requirement</strong>
        </th>
        <td mat-cell *matCellDef="let app">
          <span
            [ngClass]="getRequirementClass(app.generalMet, app.generalTotal)"
          >
            {{ app.generalMet }}/{{ app.generalTotal }}
          </span>
          <button
            mat-icon-button
            (click)="openRequirementDialog(app.generalDetails)"
          >
            <mat-icon>info</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Special Requirement -->
      <ng-container matColumnDef="special">
        <th mat-header-cell *matHeaderCellDef>
          <strong>Special Requirement</strong>
        </th>
        <td mat-cell *matCellDef="let app">
          <span
            [ngClass]="getRequirementClass(app.specialMet, app.specialTotal)"
          >
            {{ app.specialMet }}/{{ app.specialTotal }}
          </span>
          <button
            mat-icon-button
            (click)="openRequirementDialog(app.specialDetails)"
          >
            <mat-icon>info</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Status -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef><strong>Status</strong></th>
        <td mat-cell *matCellDef="let app">
          <span
            [ngClass]="getStatusClass(app.applicationStatus)"
            class="status-badge"
          >
            {{ app.applicationStatus | titlecase }}
          </span>
        </td>
      </ng-container>

      <!-- Remark -->
      <ng-container matColumnDef="remark">
        <th mat-header-cell *matHeaderCellDef><strong>Remark</strong></th>
        <td mat-cell *matCellDef="let app" class="remark-cell">
          <span class="remark-text">
            <span *ngIf="app.remark; else noRemark">{{ app.remark }}</span>
            <ng-template #noRemark>
              <i style="color: grey">N/A</i>
            </ng-template>
          </span>
          <button
            mat-icon-button
            color="primary"
            (click)="openRemarkModal(app)"
            aria-label="Edit Remark"
          >
            <mat-icon>edit</mat-icon>
          </button>
        </td>
      </ng-container>

      <!--Action-->
      <ng-container matColumnDef="action">
        <th mat-header-cell *matHeaderCellDef><strong>Action</strong></th>
        <td mat-cell *matCellDef="let app">
          <!-- Approve Button: Only if not already approved and quota not full -->
          <button
            mat-icon-button
            color="primary"
            (click)="approveSingle(app)"
            aria-label="Approve"
            [disabled]="app.applicationStatus === 'approved' || isQuotaFull()"
            matTooltip="Approve {{ app.name }}"
          >
            <mat-icon>playlist_add_check</mat-icon>
          </button>

          <!-- Reject Button: Always enabled -->
          <button
            mat-icon-button
            color="warn"
            (click)="rejectSingle(app)"
            aria-label="Reject"
            [disabled]="app.applicationStatus === 'rejected'"
            matTooltip="Reject {{ app.name }}"
          >
            <mat-icon>cancel</mat-icon>
          </button>
        </td>
      </ng-container>

      <!-- Table Headers and Rows -->
      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
    </table>
    <div *ngIf="!filteredApplicants.length" class="no-applicants">
      <i>**No applications found. Please select (another) program.</i>
    </div>

    <br />
    <div *ngIf="filteredApplicants.length > 0" class="quota-button">
      <button
        mat-raised-button
        color="primary"
        class="sort-button"
        (click)="sortApplicantsAndApprove()"
        [disabled]="isQuotaFull()"
      >
        Sort Applicants
        <mat-icon>sort</mat-icon>
      </button>
      <br /><br />
      <div
        *ngIf="isQuotaFull()"
        style="float: right; color: red; margin-top: 4px"
      >
        <i>**Maximum quota is reached</i>
      </div>
    </div>
  </div>
</div>

<ng-template #requirementDialog let-data>
  <h2 mat-dialog-title style="text-align: center">Requirements</h2>

  <mat-dialog-content>
    <div *ngIf="data?.length > 0; else noRequirements">
      <ng-container *ngFor="let group of groupByGraduateType(data)">
        <br />
        <h3 style="text-align: center; font-size: medium; color: black">
          <strong>{{ group.type }}</strong>
        </h3>
        <div *ngFor="let d of group.items">
          <span [style.color]="d.met ? 'green' : 'red'">
            {{ d.subject }}: {{ d.grade }}
          </span>
          <span [style.color]="d.met ? 'green' : 'red'">
            {{ d.met ? "✓" : "✗" }}
          </span>
          <br />
        </div>
      </ng-container>
    </div>
    <ng-template #noRequirements>
      <p>No available requirements</p>
    </ng-template>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #quotaReachedDialog let-data>
  <h2 mat-dialog-title>Failed Sorting</h2>
  <mat-dialog-content>
    {{ data.message }}
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-template>

<!-- Template for the dialog -->
<ng-template #reportDialog>
  <h2 mat-dialog-title>Application Report</h2>
  <mat-dialog-content>
    <div id="report-content">
      <table
        mat-table
        [dataSource]="sortedApplications"
        class="mat-elevation-z8"
        style="width: 100%"
      >
        <!-- Row Number Column -->
        <ng-container matColumnDef="id">
          <th mat-header-cell *matHeaderCellDef><strong>ID</strong></th>
          <td mat-cell *matCellDef="let app; let i = index">{{ i + 1 }}</td>
        </ng-container>

        <!-- Name Column -->
        <ng-container matColumnDef="name">
          <th mat-header-cell *matHeaderCellDef><strong>Name</strong></th>
          <td mat-cell *matCellDef="let app">{{ app.name }}</td>
        </ng-container>

        <!-- IC Column -->
        <ng-container matColumnDef="ic">
          <th mat-header-cell *matHeaderCellDef><strong>IC</strong></th>
          <td mat-cell *matCellDef="let app">{{ app.icNumber }}</td>
        </ng-container>

        <!-- Applied Program Column -->
        <ng-container matColumnDef="appliedProgram">
          <th mat-header-cell *matHeaderCellDef>
            <strong>Applied Program</strong>
          </th>
          <td mat-cell *matCellDef="let app">
            {{ getProgramName(app.appliedProgram) }}
            <!-- ({{ app.appliedProgram }}) -->
          </td>
        </ng-container>

        <!-- Email Column -->
        <ng-container matColumnDef="email">
          <th mat-header-cell *matHeaderCellDef><strong>Email</strong></th>
          <td mat-cell *matCellDef="let app">{{ app.address }}</td>
        </ng-container>

        <!-- Status Column -->
        <ng-container matColumnDef="status">
          <th mat-header-cell *matHeaderCellDef><strong>Status</strong></th>
          <td mat-cell *matCellDef="let app">{{ app.applicationStatus }}</td>
        </ng-container>

        <tr mat-header-row *matHeaderRowDef="displayedColumnsReport"></tr>
        <tr mat-row *matRowDef="let row; columns: displayedColumnsReport"></tr>
      </table>
    </div>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button (click)="saveToPDF()">Save to PDF</button>
    <button mat-button mat-dialog-close>Close</button>
  </mat-dialog-actions>
</ng-template>
<ng-template #successDialog>
  <h2 mat-dialog-title>Email Sent</h2>
  <mat-dialog-content>
    <p>The email was sent successfully!</p>
    <p>Please make sure email entered was correct.</p>
  </mat-dialog-content>
  <mat-dialog-actions align="end">
    <button mat-button mat-dialog-close>OK</button>
  </mat-dialog-actions>
</ng-template>

<ng-template #remarkModal>
  <h2 mat-dialog-title>Edit Remark</h2>
  <mat-dialog-content>
    <mat-form-field appearance="fill" style="width: 100%">
      <mat-label>Remark</mat-label>
      <textarea matInput rows="5" [(ngModel)]="editingRemark"></textarea>
    </mat-form-field>

    <!-- Display who and when updated -->
    <div
      *ngIf="editingApp.remarkUpdatedBy && editingApp.remarkUpdatedAt"
      style="font-size: 13px; color: gray; margin-top: 8px"
    >
      Remark last updated by <strong>{{ editingApp.remarkUpdatedBy }}</strong> on
      <strong>{{ editingApp.remarkUpdatedAt | date : "short" }}</strong>
    </div>

    <div
      *ngIf="editingApp.operationUpdatedBy && editingApp.operationUpdatedAt"
      style="font-size: 13px; color: gray; margin-top: 8px"
    >
      {{editingApp.applicationStatus | titlecase}} by <strong>{{ editingApp.operationUpdatedBy }}</strong> on
      <strong>{{ editingApp.operationUpdatedAt | date : "short" }}</strong>
    </div>
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="dialogRef.close()">Cancel</button>
    <button mat-button color="primary" (click)="saveRemark()">Save</button>
  </mat-dialog-actions>
</ng-template>
